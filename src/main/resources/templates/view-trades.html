<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaTrade - View Trades</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/newstyles2.css}">
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <div class="d-flex justify-content-between w-100 align-items-center ms-3 me-3">
            <a class="navbar-brand" th:href="@{/dashboard}">
                <img th:src="@{/img/pharmalogo.png}" alt="PharmaTrade Logo" style="height: 50px;">
            </a>
            <div class="position-absolute start-50 translate-middle-x">
                <span class="navbar-text fw-bold fs-4" style="color: #343a40;">View Trades</span>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle"></i> <span th:text="${#authentication.name}"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-gear"></i> Settings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" th:href="@{/logout}">
                        <i class="bi bi-box-arrow-right"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="d-flex flex-column min-vh-100">
    <div class="container-fluid flex-grow-1">
        <div class="row content-row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-sticky pt-3">
                    <h5 class="px-3">My Pharmacies</h5>
                    <div class="list-group list-group-flush mb-3">
                        <a th:each="pharmacy : ${user.pharmacies}"
                           th:href="@{/dashboard(pharmacyId=${pharmacy.id})}"
                           th:text="${pharmacy.name}"
                           class="list-group-item list-group-item-action">
                        </a>
                    </div>
                    <hr>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/contacts/add}">
                                <i class="bi bi-person-plus"></i> Add Contact
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" th:href="@{/trades/view}">
                                <i class="bi bi-list-check"></i> View Trades
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/pharmacies/add}">
                                <i class="bi bi-shop"></i> Add Pharmacy
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content overflow-auto py-3">
                <div class="container-fluid mt-4">
                    <!-- Filter Section -->
                    <div class="card filter-card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Filter Trades</h5>
                            <form th:action="@{/trades/view}" method="GET">
                                <div class="row g-3">
                                    <!-- Pharmacy Selection -->
                                    <div class="col-md-6">
                                        <label for="pharmacy1" class="form-label">My Pharmacy</label>
                                        <select class="form-select" id="pharmacy1" name="pharmacy1" required>
                                            <option value="">Select your pharmacy</option>
                                            <option th:each="pharmacy : ${user.pharmacies}"
                                                    th:value="${pharmacy.id}"
                                                    th:text="${pharmacy.name}"
                                                    th:selected="${pharmacy1 != null and pharmacy1 == pharmacy.id}">
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Contact Pharmacy Selection -->
                                    <div class="col-md-6">
                                        <label for="pharmacy2" class="form-label">Other Pharmacy</label>
                                        <select class="form-select" id="pharmacy2" name="pharmacy2">
                                            <option value="">All contacts</option>
                                            <optgroup label="My Pharmacies" th:if="${#lists.size(user.pharmacies) > 1}">
                                                <option th:each="pharmacy : ${user.pharmacies}"
                                                        th:if="${pharmacy.id != pharmacy1}"
                                                        th:value="${pharmacy.id}"
                                                        th:text="${pharmacy.name}"
                                                        th:selected="${pharmacy2 != null and pharmacy2 == pharmacy.id}">
                                                </option>
                                            </optgroup>
                                            <optgroup label="My Contacts">
                                                <option th:each="contact : ${contacts}"
                                                        th:value="${contact.pharmacyId}"
                                                        th:text="${contact.pharmacyName} + (${contact.contactName != null} ? ' (' + ${contact.contactName} + ')' : '')"
                                                        th:selected="${pharmacy2 != null and pharmacy2 == contact.pharmacyId}">
                                                </option>
                                            </optgroup>
                                        </select>
                                    </div>

                                    <!-- Date Range -->
                                    <div class="col-md-6">
                                        <label for="startDate" class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate"
                                               th:value="${startDate}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="endDate" class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate"
                                               th:value="${endDate}">
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-funnel"></i> Apply Filters
                                            </button>
                                            <a th:href="@{/view-trades}" class="btn btn-outline-secondary">
                                                <i class="bi bi-x-circle"></i> Clear Filters
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div class="flex-grow-1 d-flex flex-column">
                        <div th:if="${pharmacy1 != null}">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>
                                    <span th:text="${pharmacy1Name}"></span>
                                    <span th:if="${pharmacy2 != null}">
                                        <i class="bi bi-arrow-left-right mx-2"></i>
                                        <span th:text="${pharmacy2Name}"></span>
                                    </span>
                                    <span th:if="${pharmacy2 == null}"> - All Trades</span>
                                </h4>
                                <div>
                                    <a th:href="@{/trades/record(giverId=${pharmacy1}, receiverId=${pharmacy2})}"
                                       class="btn btn-sm btn-outline-primary me-2">
                                        <i class="bi bi-plus-circle"></i> New Trade
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-success me-2"
                                            data-bs-toggle="modal"
                                            data-bs-target="#settleBalanceModal"
                                            th:if="${balance != 0}">
                                        <i class="bi bi-cash-stack"></i> Settle Balance
                                    </button>
                                    <a th:href="@{/trades/view(pharmacy1=${pharmacy1}, pharmacy2=${pharmacy2}, startDate=${startDate}, endDate=${endDate})}"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-arrow-repeat"></i> Refresh
                                    </a>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="row mb-4" th:if="${pharmacy2 != null}">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">Total Trades</h6>
                                            <h4 th:text="${tradeCount}" class="card-title"></h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">You Owe</h6>
                                            <h4 class="card-title text-danger" th:if="${balance > 0}">
                                                €<span th:text="${#numbers.formatDecimal(balance, 1, 2)}"></span>
                                            </h4>
                                            <h4 class="card-title text-success" th:if="${balance <= 0}">
                                                €0.00
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">They Owe</h6>
                                            <h4 class="card-title text-success" th:if="${balance < 0}">
                                                €<span th:text="${#numbers.formatDecimal(-balance, 1, 2)}"></span>
                                            </h4>
                                            <h4 class="card-title text-danger" th:if="${balance >= 0}">
                                                €0.00
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Trades List -->
                            <div th:if="${not #lists.isEmpty(trades)}"
                                 class="trades-list-container">
                                <div class="list-group">
                                    <div th:each="trade : ${trades}" class="list-group-item p-0 mb-3 trade-card"
                                         th:classappend="${trade.giverName == pharmacy1Name} ?
                                         'trade-card-outgoing bg-light-red' : 'trade-card-incoming bg-light-green'">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <span class="badge rounded-pill me-2"
                                                          th:classappend="${trade.giverName == pharmacy1Name} ? 'badge-outgoing' : 'badge-incoming'">
                                                        <span th:text="${trade.giverName == pharmacy1Name} ? 'OUTGOING' : 'INCOMING'"></span>
                                                    </span>
                                                    <span class="text-muted small" th:text="${trade.transactionDate}"></span>
                                                </div>
                                                <h5 class="mb-0">
                                                    €<span th:text="${#numbers.formatDecimal(trade.amount, 1, 2)}"></span>
                                                </h5>
                                            </div>
                                            <p class="mt-2 mb-1" th:text="${trade.description}"></p>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <small class="text-muted">
                                                    Recorded by <span th:text="${trade.recorderUsername}"></span>
                                                    on <span th:text="${trade.createdAt}"></span>
                                                </small>
                                                <div>
                                                    <a th:href="@{/trades/record(giverId=${trade.giverName == pharmacy1Name} ? ${pharmacy1} : ${pharmacy2},
                                                                  receiverId=${trade.giverName == pharmacy1Name} ? ${pharmacy2} : ${pharmacy1})}"
                                                       class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-arrow-left-right"></i> Repeat
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pagination -->
                                <div th:if="${pharmacy2 == null and totalPages > 1}" class="d-flex justify-content-center mt-4">
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination">
                                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                                <a class="page-link"
                                                   th:href="@{'/trades/view'(
                                                   pharmacy1=${pharmacy1},
                                                   startDate=${startDate},
                                                   endDate=${endDate},
                                                   page=${currentPage - 1},
                                                   size=${pageSize})}">
                                                    Previous
                                                </a>
                                            </li>
                                            <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                                class="page-item" th:classappend="${i == currentPage} ? 'active'">
                                                <a class="page-link"
                                                   th:href="@{'/trades/view'(pharmacy1=${pharmacy1},
                                                   startDate=${startDate},
                                                   endDate=${endDate},
                                                   page=${i},
                                                   size=${pageSize})}"
                                                   th:text="${i + 1}"></a>
                                            </li>
                                            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                                <a class="page-link"
                                                   th:href="@{'/trades/view'(pharmacy1=${pharmacy1},
                                                   startDate=${startDate},
                                                   endDate=${endDate},
                                                   page=${currentPage + 1},
                                                   size=${pageSize})}">
                                                    Next
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>

                            <div th:if="${#lists.isEmpty(trades)}" class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No trades found matching your criteria.
                            </div>
                        </div>
                    </div>

                    <div th:if="${pharmacy1 == null}" class="d-flex justify-content-center align-items-center" style="height: 60vh;">
                        <div class="text-center">
                            <i class="bi bi-funnel" style="font-size: 3rem; color: #6c757d;"></i>
                            <h3 class="mt-3">Select a pharmacy to view trades</h3>
                            <p class="text-muted">Choose one of your pharmacies from the filters above</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<footer class="mt-auto">
    <div class="container text-center">
        <p class="mb-0">© 2025 Coding Factory. All rights reserved.</p>
    </div>
</footer>

<!-- Settle Balance Modal -->
<div class="modal fade" id="settleBalanceModal" tabindex="-1" aria-labelledby="settleBalanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settleBalanceModalLabel">Settle Balance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/trades/settle}" method="GET">
                <div class="modal-body">
                    <input type="hidden" name="pharmacy1" th:value="${pharmacy1}">
                    <input type="hidden" name="pharmacy2" th:value="${pharmacy2}">
                    <div class="mb-3">
                        <label for="settleDescription" class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="settleDescription" name="description" rows="3" placeholder="e.g. Balance settlement for June 2023"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Settlement</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>